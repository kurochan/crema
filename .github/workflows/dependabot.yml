name: dependabot

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  approve-allowlist:
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Check allowlist
        id: allowlist
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const allowlistPath = '.github/workflows/dependabot-allowed-dependencies.txt';
            const depsRaw = process.env.DEPENDABOT_DEPS || '';
            core.info(`Dependencies raw: ${depsRaw || '(empty)'}`);
            if (!depsRaw.trim()) {
              core.info('No dependencies found in metadata output.');
              core.setOutput('approved', 'false');
              return;
            }
            if (!fs.existsSync(allowlistPath)) {
              core.info(`Allowlist file not found: ${allowlistPath}`);
              core.setOutput('approved', 'false');
              return;
            }
            const allowed = fs
              .readFileSync(allowlistPath, 'utf8')
              .split(/\r?\n/)
              .map((line) => line.trim())
              .filter((line) => line && !line.startsWith('#'));
            if (allowed.length === 0) {
              core.setOutput('approved', 'false');
              return;
            }
            const deps = depsRaw
              .replace(/,/g, '\n')
              .split(/\r?\n/)
              .map((dep) => dep.trim())
              .filter(Boolean);
            const unmatched = deps.filter((dep) => !allowed.includes(dep));
            if (unmatched.length === 0) {
              core.info(`Allowlist match: ${deps.join(', ')}`);
            } else {
              core.info(`Allowlist mismatch: ${unmatched.join(', ')}`);
            }
            const ok = unmatched.length === 0;
            core.setOutput('approved', ok ? 'true' : 'false');
        env:
          DEPENDABOT_DEPS: ${{ steps.metadata.outputs.dependency-names }}
      - name: Enable auto-merge
        if: ${{ steps.allowlist.outputs.approved == 'true' }}
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
